{% extends "base.html" %}    

{% block content %}
<div class="container">
<form action="" method="post" novalidate>
        {{ form.hidden_tag() }}
        <p>
            {{ form.title.label }}<br>
            {{ form.title(size=32, id="title") }}
            {% if form.title.errors %}
            <div class="field-errors">
                {% for error in form.title.errors %}
                <span class="error">{{ error }}</span>
                {% endfor %}
            </div>
            {% endif %}
        </p>
        <p>
            {{ form.url.label }}<br>
            {{ form.url(size=32, id="url") }}
            {% if form.url.errors %}
            <div class="field-errors">
                {% for error in form.url.errors %}
                <span class="error">{{ error }}</span>
                {% endfor %}
            </div>
            {% endif %}
        </p>
        <p>
            {{ form.description.label }}<br>
            {{ form.description(size=32, id="description") }}
            {% if form.description.errors %}
            <div class="field-errors">
                {% for error in form.description.errors %}
                <span class="error">{{ error }}</span>
                {% endfor %}
            </div>
            {% endif %}
        </p>
        <p>
            {{ form.tags.label }}<br>
            <div class="tag-input-container">
                {{ form.tags(style="display: none;", id="tags-input") }}
                <div class="tag-pills-container" id="tag-pills-container">
                    <input type="text" class="tag-input-field" id="tag-input-field" placeholder="Add tags...">
                </div>
                <div id="tag-suggestions" class="tag-suggestions"></div>
            </div>
        </p>
        <p>{{ form.submit() }}</p>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const hiddenTagsInput = document.getElementById('tags-input');
    const tagInputField = document.getElementById('tag-input-field');
    const tagPillsContainer = document.getElementById('tag-pills-container');
    const suggestionsDiv = document.getElementById('tag-suggestions');
    let allTags = [];
    let currentTags = [];
    let selectedSuggestionIndex = -1;
    
    // Fetch all available tags
    fetch('/api/tags')
        .then(response => response.json())
        .then(tags => {
            allTags = tags;
        });
    
    // Initialize with existing tags if any
    const existingTags = hiddenTagsInput.value;
    if (existingTags) {
        currentTags = existingTags.split(',').map(tag => tag.trim()).filter(tag => tag);
        renderTags();
    }
    
    // Handle input events for autocomplete
    tagInputField.addEventListener('input', function() {
        const currentValue = this.value.trim();
        
        if (currentValue.length >= 1) {
            // Filter matching tags
            const matches = allTags.filter(tag => 
                tag.toLowerCase().includes(currentValue.toLowerCase()) &&
                !currentTags.includes(tag)
            ).slice(0, 5); // Show max 5 suggestions
            
            showSuggestions(matches);
        } else {
            hideSuggestions();
        }
    });
    
    // Handle key events
    tagInputField.addEventListener('keydown', function(e) {
        const suggestions = suggestionsDiv.querySelectorAll('.tag-suggestion');
        const isDropdownVisible = suggestionsDiv.style.display === 'block';
        
        if (e.key === 'ArrowDown' && isDropdownVisible) {
            e.preventDefault();
            selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, suggestions.length - 1);
            updateSelectedSuggestion();
        } else if (e.key === 'ArrowUp' && isDropdownVisible) {
            e.preventDefault();
            selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
            updateSelectedSuggestion();
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (isDropdownVisible && selectedSuggestionIndex >= 0) {
                const selectedTag = suggestions[selectedSuggestionIndex].dataset.tag;
                selectTag(selectedTag);
            } else {
                addCurrentTag();
            }
        } else if (e.key === 'Tab' && isDropdownVisible && selectedSuggestionIndex >= 0) {
            e.preventDefault();
            const selectedTag = suggestions[selectedSuggestionIndex].dataset.tag;
            selectTag(selectedTag);
        } else if (e.key === 'Escape' && isDropdownVisible) {
            e.preventDefault();
            hideSuggestions();
        } else if (e.key === ',') {
            e.preventDefault();
            addCurrentTag();
        } else if (e.key === 'Backspace' && this.value === '' && currentTags.length > 0) {
            // Remove last tag if input is empty
            removeTag(currentTags.length - 1);
        } else {
            // Reset selection when typing
            selectedSuggestionIndex = -1;
        }
    });
    
    // Focus the input when clicking on the container
    tagPillsContainer.addEventListener('click', function(e) {
        if (e.target === this || e.target.classList.contains('tag-input-field')) {
            tagInputField.focus();
        }
    });
    
    function addCurrentTag() {
        const tagValue = tagInputField.value.trim();
        if (tagValue && !currentTags.includes(tagValue)) {
            currentTags.push(tagValue);
            tagInputField.value = '';
            renderTags();
            updateHiddenInput();
            hideSuggestions();
        }
    }
    
    function removeTag(index) {
        currentTags.splice(index, 1);
        renderTags();
        updateHiddenInput();
        tagInputField.focus();
    }
    
    function renderTags() {
        // Clear existing pills (but keep the input field)
        const pills = tagPillsContainer.querySelectorAll('.tag-pill');
        pills.forEach(pill => pill.remove());
        
        // Add tag pills before the input field
        currentTags.forEach((tag, index) => {
            const pill = document.createElement('div');
            pill.className = 'tag-pill';
            pill.innerHTML = `${tag}<span class="tag-pill-remove" data-index="${index}">Ã—</span>`;
            
            // Add click handler for remove button
            pill.querySelector('.tag-pill-remove').addEventListener('click', function() {
                removeTag(parseInt(this.dataset.index));
            });
            
            tagPillsContainer.insertBefore(pill, tagInputField);
        });
    }
    
    function updateHiddenInput() {
        hiddenTagsInput.value = currentTags.join(',');
    }
    
    function updateSelectedSuggestion() {
        const suggestions = suggestionsDiv.querySelectorAll('.tag-suggestion');
        suggestions.forEach((suggestion, index) => {
            suggestion.classList.toggle('selected', index === selectedSuggestionIndex);
        });
    }
    
    function showSuggestions(matches) {
        if (matches.length === 0) {
            hideSuggestions();
            return;
        }
        
        selectedSuggestionIndex = -1; // Reset selection
        
        suggestionsDiv.innerHTML = matches.map(tag => 
            `<div class="tag-suggestion" data-tag="${tag}">${tag}</div>`
        ).join('');
        
        suggestionsDiv.style.display = 'block';
        
        // Add click handlers
        suggestionsDiv.querySelectorAll('.tag-suggestion').forEach(suggestion => {
            suggestion.addEventListener('click', function() {
                selectTag(this.dataset.tag);
            });
        });
    }
    
    function hideSuggestions() {
        suggestionsDiv.style.display = 'none';
    }
    
    function selectTag(selectedTag) {
        if (!currentTags.includes(selectedTag)) {
            currentTags.push(selectedTag);
            tagInputField.value = '';
            renderTags();
            updateHiddenInput();
            hideSuggestions();
            tagInputField.focus();
        }
    }
    
    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!tagPillsContainer.contains(e.target) && !suggestionsDiv.contains(e.target)) {
            hideSuggestions();
        }
    });
});

// Form validation
function validateForm() {
    const title = document.getElementById('title').value.trim();
    const url = document.getElementById('url').value.trim();
    const description = document.getElementById('description').value.trim();
    
    // Clear previous errors
    document.querySelectorAll('.client-error').forEach(error => error.remove());
    
    let isValid = true;
    
    // Validate title
    if (!title) {
        showClientError('title', 'Title is required');
        isValid = false;
    } else if (title.length > 200) {
        showClientError('title', 'Title must be less than 200 characters');
        isValid = false;
    }
    
    // Validate URL
    if (!url) {
        showClientError('url', 'URL is required');
        isValid = false;
    } else {
        try {
            new URL(url);
        } catch {
            showClientError('url', 'Please enter a valid URL');
            isValid = false;
        }
    }
    
    // Validate description
    if (!description) {
        showClientError('description', 'Description is required');
        isValid = false;
    } else if (description.length > 1000) {
        showClientError('description', 'Description must be less than 1000 characters');
        isValid = false;
    }
    
    return isValid;
}

function showClientError(fieldName, message) {
    const field = document.getElementById(fieldName);
    const errorDiv = document.createElement('div');
    errorDiv.className = 'field-errors';
    errorDiv.innerHTML = `<span class="error client-error">${message}</span>`;
    field.parentNode.appendChild(errorDiv);
}

// Add form validation on submit
document.querySelector('form').addEventListener('submit', function(e) {
    if (!validateForm()) {
        e.preventDefault();
    }
});

// Add real-time validation
['title', 'url', 'description'].forEach(fieldName => {
    const field = document.getElementById(fieldName);
    if (field) {
        field.addEventListener('blur', validateForm);
    }
});
</script>

    {% endblock %}
