{% extends "base.html" %}    

{% block content %}
<div class="container">
<form action="" method="post" novalidate>
        {{ form.hidden_tag() }}
        <p>
            {{ form.title.label }}<br>
            {{ form.title(size=32) }}
        </p>
        <p>
            {{ form.url.label }}<br>
            {{ form.url(size=32) }}
        </p>
        <p>
            {{ form.description.label }}<br>
            {{ form.description(size=32) }}
        </p>
        <p>
            {{ form.tags.label }}<br>
            <div class="tag-input-container">
                {{ form.tags(size=32, id="tags-input") }}
                <div id="tag-suggestions" class="tag-suggestions"></div>
            </div>
        </p>
        <p>{{ form.submit() }}</p>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tagsInput = document.getElementById('tags-input');
    const suggestionsDiv = document.getElementById('tag-suggestions');
    let allTags = [];
    
    // Fetch all available tags
    fetch('/api/tags')
        .then(response => response.json())
        .then(tags => {
            allTags = tags;
        });
    
    // Handle input events
    tagsInput.addEventListener('input', function() {
        const currentValue = this.value;
        const cursorPos = this.selectionStart;
        
        // Find the current tag being typed
        const beforeCursor = currentValue.substring(0, cursorPos);
        const lastCommaIndex = beforeCursor.lastIndexOf(',');
        const currentTag = beforeCursor.substring(lastCommaIndex + 1).trim();
        
        if (currentTag.length >= 1) {
            // Filter matching tags
            const matches = allTags.filter(tag => 
                tag.toLowerCase().includes(currentTag.toLowerCase()) &&
                !getCurrentTags(currentValue).includes(tag)
            ).slice(0, 5); // Show max 5 suggestions
            
            showSuggestions(matches, currentTag);
        } else {
            hideSuggestions();
        }
    });
    
    function getCurrentTags(value) {
        return value.split(',').map(tag => tag.trim()).filter(tag => tag);
    }
    
    function showSuggestions(matches, currentTag) {
        if (matches.length === 0) {
            hideSuggestions();
            return;
        }
        
        suggestionsDiv.innerHTML = matches.map(tag => 
            `<div class="tag-suggestion" data-tag="${tag}">${tag}</div>`
        ).join('');
        
        suggestionsDiv.style.display = 'block';
        
        // Add click handlers
        suggestionsDiv.querySelectorAll('.tag-suggestion').forEach(suggestion => {
            suggestion.addEventListener('click', function() {
                selectTag(this.dataset.tag);
            });
        });
    }
    
    function hideSuggestions() {
        suggestionsDiv.style.display = 'none';
    }
    
    function selectTag(selectedTag) {
        const currentValue = tagsInput.value;
        const cursorPos = tagsInput.selectionStart;
        const beforeCursor = currentValue.substring(0, cursorPos);
        const afterCursor = currentValue.substring(cursorPos);
        
        const lastCommaIndex = beforeCursor.lastIndexOf(',');
        const newValue = beforeCursor.substring(0, lastCommaIndex + 1) + 
                        (lastCommaIndex >= 0 ? ' ' : '') + 
                        selectedTag + ', ' + afterCursor;
        
        tagsInput.value = newValue;
        tagsInput.focus();
        
        // Position cursor after the selected tag
        const newCursorPos = (lastCommaIndex >= 0 ? lastCommaIndex + 2 : 0) + selectedTag.length + 2;
        tagsInput.setSelectionRange(newCursorPos, newCursorPos);
        
        hideSuggestions();
    }
    
    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!tagsInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
            hideSuggestions();
        }
    });
});
</script>

    {% endblock %}
